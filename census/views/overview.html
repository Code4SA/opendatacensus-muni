{% extends "base.html" %}

{% block title %}{{gettext("Overview")}}{% endblock %}
{% block bodyclass %}overview {% if extraWidth %}extrawidth{% endif %}{% endblock %}

{% block content %}

<div class="page-header">
  <div class="summary featured">
    <dl>
      <dt>{{gettext("Number of places")}}</dt>
      <dd id="nc">{{ placeCount }}</dd>
      <dt>{{gettext("Number of datasets")}}</dt>
      <dd id="nds">{{ currentEntryCount }}</dd>
      <dt>{{gettext("Number of open datasets")}}</dt>
      <dd id="nok">{{ currentEntryOpenCount }}</dd>
      <dt>{{gettext("Percentage")}} <a href="http://okfn.org/opendata/">{{gettext("open")}}</a></dt>
      <dd id="nokpercent">{{ openDataPercent }}%</dd>
    </dl>
  </div>
</div>

{% if customText %}
<div class="custom-intro">
  {{ customText }}
</div>
{% endif %}

<div class="row">
  <div class="pull-left">{% include '_snippets/key.html' %}</div>

  <div class="pull-right">
    {% if submissionsAllowed %}
    <a href="/census/submit/" class="btn btn-primary">
      <i class="icon-plus"></i> {{ gettext("Add information") }}
    </a>
    {% endif %}

    {% if missingPlaceText %}
    {% include '_snippets/missing_place_button.html' %}
    {% endif %}
  </div>
</div>

<div class="row">
  {% include '_snippets/year_navigation.html' %}
</div>

<table class="response-summary table">
  <thead>
    <tr>
      <th colspan="2">&nbsp;</th>
      {% for dataset in datasets %}
      <th><div><a href="/dataset/{{dataset.id}}/{{ year }}">{{ dataset.name }}</a></div></th>
      {% endfor %}
      <th><div><strong>{{gettext("Total Score")}}</strong></div>
    </tr>
  </thead>
  <tbody>
    {% if places.length == 0 %}
    <tr>
      <td colspan="2"></td>
      <td colspan="10">
        <strong><em>{{gettext("The Census Admin needs to add some places to the Places configuration sheet")}}</em></strong>
      </td>
    </tr>
    {% endif %}

    {% for place in places %}
    <tr
       {#
       data-* are values needed for doing sorting

       note we have place name not by id to avoid odd ux (e.g. united
       arab emirates should come under 'u' but its iso code is 'ae'
       #}
       data-score="{{place.computedScore}}"
       data-place="{{place.id}}"
       data-placename="{{place.name}}">
      <td>{{ loop.index }}</td>
      <th class="place-name">
        {% if place %}
        <a href="/place/{{ place.id }}/{{ year }}">{{place.name}}</a>
        {% else %}
        <a href="submit/" data-toggle="tooltip" class="unknown no-data count-0" title="{{gettext("Click here to add to the census!")}}">{{gettext("Add new")}}</a>
        {% endif %}
      </th>
      {% for dataset in datasets %}

      {% set entry = entries|find({'dataset': dataset.id , 'place': place.id }) %}
      <td
         class="
                ycount-{{entry.computedYCount}}
                showpopover
                "
         data-dataset="{{entry.dataset}}"
         data-datasetTitle="{{dataset.title}}"
         >
        {% if entry %}
        <ul class="availability icons mini">
          {% for qu in questions %}
          {% set state = entry.answers[qu.id] %}

          {% if state == true %}
            {% set stateClass = 'yes' %}
            {% set stateDisplay = 'Y' %}
          {% elif state == false %}
            {% set stateClass = 'no' %}
            {% set stateDisplay = 'N' %}
          {% elif state == null %}
            {% set stateClass = 'maybe' %}
            {% set stateDisplay = '?' %}
          {% endif %}

          <li class="{{ stateClass }}" data-toggle="tooltip" title="{{ qu.question }}">
            <i class="icon-{{ qu.icon }}"></i>
            <span class="text">{{ stateDisplay }}</span>
          </li>
          {% endfor %}
        </ul>
        {% else %}
        {% if submissionsAllowed %}
        <a href="/place/{{ place.id }}" class="btn btn-mini">
          <i class="icon-plus"></i>
          Add
        </a>
        {% else %}
        <i class="muted">None</i>
        {% endif %}
        {% endif %}
      </td>
      {% endfor %}
      <td class="placescore" data-score="{{place.computedScore}}"><span>{{place.computedScore}}</span></td>
    </tr>
    {% endfor %}
  </tbody>
  <tfoot>
    <tr>
      <th colspan="2">&nbsp;</th>
      {% for dataset in datasets %}
      <th><div><a href="/dataset/{{dataset.id}}">{{ dataset.name }}</a></div></th>
      {% endfor %}
      <th><div><strong>{{gettext("Total Score")}}</strong></div>
    </tr>
  </tfoot>
</table>

<div class="row-fluid">
  {% include '_snippets/key.html' %}
</div>
<script src="{{page.root}}/vendor/sticky.min.js"></script>
<script src="{{page.root}}/src/common.js"></script>
<script src="{{page.root}}/src/census.js"></script>
{% endblock %}
